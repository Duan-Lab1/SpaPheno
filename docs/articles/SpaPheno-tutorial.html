<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>SpaPheno Tutorial: Linking Spatial Transcriptomics to Clinical Phenotypes with Interpretable Machine Learning • SpaPheno</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="SpaPheno Tutorial: Linking Spatial Transcriptomics to Clinical Phenotypes with Interpretable Machine Learning">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">SpaPheno</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.1</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/SpaPheno-tutorial.html">SpaPheno Tutorial: Linking Spatial Transcriptomics to Clinical Phenotypes with Interpretable Machine Learning</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="nav-link" href="https://github.com/Duan-Lab1/SpaPheno/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>SpaPheno Tutorial: Linking Spatial Transcriptomics to Clinical Phenotypes with Interpretable Machine Learning</h1>
                        <h4 data-toc-skip class="author">Bin Duan</h4>
            <address class="author_afil">
      SJTU<br><a class="author_email" href="mailto:#"></a><a href="mailto:binduan@sjtu.edu.cn" class="email">binduan@sjtu.edu.cn</a>
      </address>
                  
            <h4 data-toc-skip class="date">2025-08-09</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/Duan-Lab1/SpaPheno/blob/HEAD/vignettes/SpaPheno-tutorial.Rmd"><code>vignettes/SpaPheno-tutorial.Rmd</code></a></small>
      <div class="d-none name"><code>SpaPheno-tutorial.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>Linking spatial transcriptomic patterns to clinically relevant
phenotypes is a critical step toward spatially informed precision
oncology. Here, we introduce SpaPheno, an interpretable machine learning
framework that integrates spatial transcriptomics with clinically
annotated bulk RNA-seq data to uncover spatially resolved biomarkers
predictive of patient outcomes. Leveraging Elastic Net regression
combined with SHAP-based attribution, SpaPheno uniquely identifies
spatial features at multiple scales—from tissue regions to specific cell
types and individual spatial spots—that are associated with patient
survival, tumor stage, and immunotherapy response. We demonstrate the
robustness and generalizability of SpaPheno through comprehensive
simulations and applications spanning primary liver cancer, clear cell
renal cell carcinoma, breast cancer, and melanoma. Across these diverse
settings, SpaPheno achieves high predictive accuracy while providing
biologically meaningful and spatially precise interpretations. Our
framework offers a powerful and extensible approach for translating
complex spatial omics data into actionable clinical insights,
accelerating the development of precision oncology strategies grounded
in tumor spatial architecture.</p>
<p><strong>SpaPheno</strong> is an R package designed to identify,
visualize, and interpret spatial phenotype associations from spatial
transcriptomics and simulated bulk data. Here are Key Features:</p>
<ul>
<li><p><strong>Integration of spatial transcriptomics with clinically
annotated bulk RNA-seq data</strong></p></li>
<li><p><strong>Multi-scale interpretable machine learning
framework</strong></p></li>
<li><p><strong>Robust applicability across diverse cancer types and
clinical endpoints</strong></p></li>
</ul>
<div class="figure" style="text-align: center">
<img src="figures%2Fworkflow.jpg" alt="The Overview of SpaPheno" width="80%" height="80%"><p class="caption">
The Overview of SpaPheno
</p>
</div>
</div>
<div class="section level2">
<h2 id="installation">Installation<a class="anchor" aria-label="anchor" href="#installation"></a>
</h2>
<p>To get started with <strong>SpaPheno</strong>, ensure that you have
the required dependencies installed. The package relies on a set of CRAN
and Bioconductor packages such as glmnet, FNN, and survival. You can
install them via BiocManager if not already available.</p>
<p>Next, install <strong>SpaPheno</strong> directly from GitHub using
devtools. This will fetch the latest development version maintained by
the authors.</p>
<p>Once installed, load the core packages used throughout the SpaPheno
workflow, including ggplot2 for visualization and tidyverse for data
handling.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">require</a></span><span class="op">(</span><span class="st"><a href="https://bioconductor.github.io/BiocManager/" class="external-link">"BiocManager"</a></span>, quietly <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html" class="external-link">install.packages</a></span><span class="op">(</span><span class="st">"BiocManager"</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co">## Install suggested packages</span></span>
<span><span class="co"># BiocManager::install(c(</span></span>
<span><span class="co">#   "glmnet",</span></span>
<span><span class="co">#   "FNN",</span></span>
<span><span class="co">#   "survival"</span></span>
<span><span class="co"># ))</span></span>
<span></span>
<span><span class="co"># install.packages("devtools")</span></span>
<span><span class="co"># devtools::install_github("bm2-lab/SpaDo")</span></span>
<span></span>
<span><span class="co"># SpaPheno installation</span></span>
<span><span class="co"># devtools::install_github("Duan-Lab1/SpaPheno", dependencies = c("Depends", "Imports", "LinkingTo"))</span></span>
<span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/Duan-Lab1/SpaPheno">SpaPheno</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org" class="external-link">tidyverse</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/hadley/reshape" class="external-link">reshape2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://stringr.tidyverse.org" class="external-link">stringr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/therneau/survival" class="external-link">survival</a></span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="data-availability">Data availability<a class="anchor" aria-label="anchor" href="#data-availability"></a>
</h2>
<p>The data required for the test are all listed in the following google
cloud directory <a href="https://drive.google.com/drive/folders/1tiSgMjhzvIsirvJwFDIAQIEIhR7qixUW?usp=drive_link" class="external-link">SpaPheno
Demo Data</a>.</p>
<pre><code>├── BRCAsurvival.RData
├── HCC_stage.RData
├── HCC_survival.RData
├── KIRC_survival.RData
├── Melanoma_ICB.RData
├── Simulation_osmFISH.RData
└── Simulation_STARmap.RData</code></pre>
</div>
<div class="section level2">
<h2 id="simulation-osmfish">Simulation osmFISH<a class="anchor" aria-label="anchor" href="#simulation-osmfish"></a>
</h2>
<p>This tutorial demonstrates the workflow of <strong>SpaPheno</strong>
using simulated osmFISH data, including:</p>
<ol style="list-style-type: decimal">
<li>Loading and visualizing spatial cell annotations.</li>
<li>Defining simulated phenotypes across spatial regions.</li>
<li>Generating pseudo-bulk samples for phenotype modeling.</li>
<li>Building a logistic regression model via automated regularization
selection.</li>
<li>Performing spatial phenotype risk prediction.</li>
<li>Interpreting key contributing cell types using SHAP values.</li>
<li>Exploring spatial patterns of model residuals for biological
insight.</li>
</ol>
<p>Together, this pipeline allows researchers to integrate spatial
structure, cell composition, and predictive modeling to understand how
local cell-type environments contribute to complex phenotypes.</p>
<div class="section level3">
<h3 id="load-data">load data<a class="anchor" aria-label="anchor" href="#load-data"></a>
</h3>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/rm.html" class="external-link">rm</a></span><span class="op">(</span>list <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ls.html" class="external-link">ls</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/load.html" class="external-link">load</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>, <span class="st">"Simulation_osmFISH.RData"</span>, package <span class="op">=</span> <span class="st">"SpaPheno"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">test_coordinate</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">X</span>, y <span class="op">=</span> <span class="va">Y</span>, color <span class="op">=</span> <span class="va">sample_information_cellType</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<p><img src="SpaPheno-tutorial_files/figure-html/unnamed-chunk-3-1.png" width="700" style="display: block; margin: auto;"></p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">test_coordinate</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">X</span>, y <span class="op">=</span> <span class="va">Y</span>, color <span class="op">=</span> <span class="va">sample_information_region</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<p><img src="SpaPheno-tutorial_files/figure-html/unnamed-chunk-3-2.png" width="700" style="display: block; margin: auto;"></p>
</div>
<div class="section level3">
<h3 id="choose-simulated-phenotypes">Choose simulated phenotypes<a class="anchor" aria-label="anchor" href="#choose-simulated-phenotypes"></a>
</h3>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">region_all</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/table.html" class="external-link">table</a></span><span class="op">(</span><span class="va">sample_information_region</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">phenotype_simu</span> <span class="op">&lt;-</span> <span class="va">region_all</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">3</span>, <span class="fl">4</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="va">sample_information_region_choose</span> <span class="op">&lt;-</span> <span class="va">sample_information_region</span></span>
<span><span class="va">sample_information_region_choose</span><span class="op">[</span><span class="op">!</span><span class="va">sample_information_region_choose</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">phenotype_simu</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="cn">NA</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="ground-truth-of-simulated-phenotypes">Ground truth of simulated phenotypes<a class="anchor" aria-label="anchor" href="#ground-truth-of-simulated-phenotypes"></a>
</h3>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">custom_colors</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"red"</span>, <span class="st">"lightgray"</span>, <span class="st">"blue"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">custom_colors</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">phenotype_simu</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, <span class="st">"Background"</span>, <span class="va">phenotype_simu</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">sample_information_region_choose</span><span class="op">[</span><span class="op">!</span><span class="va">sample_information_region_choose</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">phenotype_simu</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"Background"</span></span>
<span><span class="va">Ground_truth</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">sample_information_region_choose</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/row.names.html" class="external-link">row.names</a></span><span class="op">(</span><span class="va">test_coordinate</span><span class="op">)</span><span class="op">]</span>, levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">phenotype_simu</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="st">"Background"</span>, <span class="va">phenotype_simu</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">test_coordinate</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">X</span>, y <span class="op">=</span> <span class="va">Y</span>, color <span class="op">=</span> <span class="va">Ground_truth</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_color_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="va">custom_colors</span><span class="op">)</span></span></code></pre></div>
<p><img src="SpaPheno-tutorial_files/figure-html/unnamed-chunk-5-1.png" width="700" style="display: block; margin: auto;"></p>
</div>
<div class="section level3">
<h3 id="simulating-bulk-data-with-phenotypes">Simulating bulk data with phenotypes<a class="anchor" aria-label="anchor" href="#simulating-bulk-data-with-phenotypes"></a>
</h3>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pseudo_bulk_simi</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/generate_simulated_bulk_data.html">generate_simulated_bulk_data</a></span><span class="op">(</span></span>
<span>  input_data <span class="op">=</span> <span class="va">sample_information_cellType</span>, </span>
<span>  region_labels <span class="op">=</span> <span class="va">sample_information_region</span>, </span>
<span>  phenotypes <span class="op">=</span> <span class="va">phenotype_simu</span>, </span>
<span>  perturbation_percent <span class="op">=</span> <span class="fl">0.1</span>, </span>
<span>  num_samples <span class="op">=</span> <span class="fl">50</span>, </span>
<span>  mode <span class="op">=</span> <span class="st">"proportion"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">pseudo_bulk_df1</span> <span class="op">&lt;-</span> <span class="va">pseudo_bulk_simi</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="va">pseudo_bulk_df2</span> <span class="op">&lt;-</span> <span class="va">pseudo_bulk_simi</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span></span>
<span></span>
<span><span class="va">bulk_decon</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">pseudo_bulk_df1</span>, <span class="va">pseudo_bulk_df2</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">bulk_pheno</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>, each <span class="op">=</span> <span class="fl">50</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">bulk_pheno</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">pseudo_bulk_df1</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">pseudo_bulk_df2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">family</span> <span class="op">&lt;-</span> <span class="st">"binomial"</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="obtaining-prediction-results">Obtaining prediction results<a class="anchor" aria-label="anchor" href="#obtaining-prediction-results"></a>
</h3>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">PhenoResult</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/SpatialPhenoMap.html">SpatialPhenoMap</a></span><span class="op">(</span></span>
<span>  bulk_decon <span class="op">=</span> <span class="va">bulk_decon</span>, </span>
<span>  bulk_pheno <span class="op">=</span> <span class="va">bulk_pheno</span>, </span>
<span>  family <span class="op">=</span> <span class="va">family</span>, </span>
<span>  coord <span class="op">=</span> <span class="va">test_coordinate</span>, </span>
<span>  resolution <span class="op">=</span> <span class="st">"single_cell"</span>, </span>
<span>  sample_information_cellType <span class="op">=</span> <span class="va">sample_information_cellType</span>, </span>
<span>  n_perm <span class="op">=</span> <span class="fl">1</span>, </span>
<span>  p <span class="op">=</span> <span class="fl">0.001</span><span class="op">)</span></span></code></pre></div>
<p><img src="SpaPheno-tutorial_files/figure-html/unnamed-chunk-7-1.png" width="700" style="display: block; margin: auto;"><img src="SpaPheno-tutorial_files/figure-html/unnamed-chunk-7-2.png" width="700" style="display: block; margin: auto;"><img src="SpaPheno-tutorial_files/figure-html/unnamed-chunk-7-3.png" width="700" style="display: block; margin: auto;"></p>
</div>
<div class="section level3">
<h3 id="shap-analysis">SHAP analysis<a class="anchor" aria-label="anchor" href="#shap-analysis"></a>
</h3>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pred_result</span> <span class="op">&lt;-</span> <span class="va">PhenoResult</span><span class="op">$</span><span class="va">pred_score</span></span>
<span><span class="va">phenoPlus</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/row.names.html" class="external-link">row.names</a></span><span class="op">(</span><span class="va">pred_result</span><span class="op">[</span><span class="va">pred_result</span><span class="op">$</span><span class="va">label</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="st">"phenotype+"</span>, <span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="va">model</span> <span class="op">&lt;-</span> <span class="va">PhenoResult</span><span class="op">$</span><span class="va">model</span></span>
<span><span class="va">X</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="va">PhenoResult</span><span class="op">$</span><span class="va">cell_type_distribution</span><span class="op">[</span><span class="va">phenoPlus</span>, <span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## This step took a very long time</span></span>
<span><span class="co"># shap_test_plus &lt;- compute_shap_spatial(</span></span>
<span><span class="co">#   model = model, </span></span>
<span><span class="co">#   X_bulk = as.data.frame(bulk_decon), </span></span>
<span><span class="co">#   y_bulk = bulk_pheno, </span></span>
<span><span class="co">#   X_spatial = X)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">shap_test_plus</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##           feature           phi      phi.var feature.value    sample</span></span>
<span><span class="co">## 1  Astrocyte.Gfap  0.0000000000 0.000000e+00          0.08 cell_5682</span></span>
<span><span class="co">## 2 Astrocyte.Mfge8  0.0000000000 0.000000e+00          0.04 cell_5682</span></span>
<span><span class="co">## 3       C..Plexus -0.0134631352 4.616196e-03          0.02 cell_5682</span></span>
<span><span class="co">## 4     Endothelial  0.0000000000 0.000000e+00          0.06 cell_5682</span></span>
<span><span class="co">## 5   Endothelial.1  0.0002035102 1.812159e-05          0.02 cell_5682</span></span>
<span><span class="co">## 6       Ependymal  0.0000000000 0.000000e+00          0.00 cell_5682</span></span></code></pre>
</div>
<div class="section level3">
<h3 id="shap-summary-plot">SHAP summary plot<a class="anchor" aria-label="anchor" href="#shap-summary-plot"></a>
</h3>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/SpaPheno_SHAP_summary_plot.html">SpaPheno_SHAP_summary_plot</a></span><span class="op">(</span><span class="va">shap_test_plus</span>, top_n <span class="op">=</span> <span class="fl">31</span><span class="op">)</span></span></code></pre></div>
<p><img src="SpaPheno-tutorial_files/figure-html/unnamed-chunk-9-1.png" width="700" style="display: block; margin: auto;"></p>
</div>
<div class="section level3">
<h3 id="shap-residual-analysis">SHAP residual analysis<a class="anchor" aria-label="anchor" href="#shap-residual-analysis"></a>
</h3>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">resi_result</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/SpaPheno_SHAP_residual_analysis.html">SpaPheno_SHAP_residual_analysis</a></span><span class="op">(</span></span>
<span>  shap_df <span class="op">=</span> <span class="va">shap_test_plus</span>,</span>
<span>  feature_name <span class="op">=</span> <span class="st">"Perivascular.Macrophages"</span>,</span>
<span>  coordinate_df <span class="op">=</span> <span class="va">test_coordinate</span>, size <span class="op">=</span> <span class="fl">0.8</span></span>
<span><span class="op">)</span></span>
<span><span class="va">resi_hot</span> <span class="op">&lt;-</span> <span class="va">resi_result</span><span class="op">$</span><span class="va">residual_table</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">resi_hot</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/order.html" class="external-link">order</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">resi_hot</span><span class="op">$</span><span class="va">phi_resid_z</span><span class="op">)</span>, decreasing <span class="op">=</span> <span class="cn">T</span><span class="op">)</span>, <span class="op">]</span>, <span class="fl">5</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##                      feature        phi   phi.var feature.value    sample</span></span>
<span><span class="co">## 420 Perivascular.Macrophages  0.3887959 0.2184542          0.06 cell_5612</span></span>
<span><span class="co">## 483 Perivascular.Macrophages -0.2546234 0.1502212          0.00 cell_4530</span></span>
<span><span class="co">## 493 Perivascular.Macrophages -0.2535509 0.1451300          0.00 cell_4650</span></span>
<span><span class="co">## 457 Perivascular.Macrophages  0.5548111 0.2055735          0.12 cell_5593</span></span>
<span><span class="co">## 39  Perivascular.Macrophages  0.3240469 0.1976987          0.04 cell_5790</span></span>
<span><span class="co">##     phi_residual phi_resid_z   resid_group color_group</span></span>
<span><span class="co">## 420    0.2360473    2.642347 High residual        High</span></span>
<span><span class="co">## 483   -0.2356644   -2.638060  Low residual         Low</span></span>
<span><span class="co">## 493   -0.2345918   -2.626054  Low residual         Low</span></span>
<span><span class="co">## 457    0.2303550    2.578626 High residual        High</span></span>
<span><span class="co">## 39     0.2285343    2.558245 High residual        High</span></span></code></pre>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/SpaPheno_SHAP_waterfall_plot.html">SpaPheno_SHAP_waterfall_plot</a></span><span class="op">(</span><span class="va">shap_test_plus</span>, <span class="st">"cell_5593"</span>, top_n <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></span></code></pre></div>
<p><img src="SpaPheno-tutorial_files/figure-html/unnamed-chunk-10-1.png" width="700" style="display: block; margin: auto;"></p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">resi_result</span><span class="op">$</span><span class="va">dependence_plot</span></span></code></pre></div>
<p><img src="SpaPheno-tutorial_files/figure-html/unnamed-chunk-10-2.png" width="700" style="display: block; margin: auto;"></p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">resi_result</span><span class="op">$</span><span class="va">spatial_plot</span></span></code></pre></div>
<p><img src="SpaPheno-tutorial_files/figure-html/unnamed-chunk-10-3.png" width="700" style="display: block; margin: auto;"></p>
</div>
</div>
<div class="section level2">
<h2 id="simulation-starmap">Simulation STARmap<a class="anchor" aria-label="anchor" href="#simulation-starmap"></a>
</h2>
<div class="section level3">
<h3 id="load-data-1">load data<a class="anchor" aria-label="anchor" href="#load-data-1"></a>
</h3>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/rm.html" class="external-link">rm</a></span><span class="op">(</span>list <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ls.html" class="external-link">ls</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/load.html" class="external-link">load</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>, <span class="st">"Simulation_STARmap.RData"</span>, package <span class="op">=</span> <span class="st">"SpaPheno"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">test_coordinate</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">X</span>, y <span class="op">=</span> <span class="va">Y</span>, color <span class="op">=</span> <span class="va">sample_information_cellType</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="SpaPheno-tutorial_files/figure-html/unnamed-chunk-11-1.png" width="700" style="display: block; margin: auto;"></p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">test_coordinate</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">X</span>, y <span class="op">=</span> <span class="va">Y</span>, color <span class="op">=</span> <span class="va">sample_information_region</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="SpaPheno-tutorial_files/figure-html/unnamed-chunk-11-2.png" width="700" style="display: block; margin: auto;"></p>
</div>
<div class="section level3">
<h3 id="choose-simulated-phenotypes-1">Choose simulated phenotypes<a class="anchor" aria-label="anchor" href="#choose-simulated-phenotypes-1"></a>
</h3>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">region_all</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/table.html" class="external-link">table</a></span><span class="op">(</span><span class="va">sample_information_region</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">phenotype_simu</span> <span class="op">&lt;-</span> <span class="va">region_all</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">6</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="va">sample_information_region_choose</span> <span class="op">&lt;-</span> <span class="va">sample_information_region</span></span>
<span><span class="va">sample_information_region_choose</span><span class="op">[</span><span class="op">!</span><span class="va">sample_information_region_choose</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">phenotype_simu</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="cn">NA</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="ground-truth-of-simulated-phenotypes-1">Ground truth of simulated phenotypes<a class="anchor" aria-label="anchor" href="#ground-truth-of-simulated-phenotypes-1"></a>
</h3>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">custom_colors</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"red"</span>, <span class="st">"lightgray"</span>, <span class="st">"blue"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">custom_colors</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">phenotype_simu</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, <span class="st">"Background"</span>, <span class="va">phenotype_simu</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">sample_information_region_choose</span><span class="op">[</span><span class="op">!</span><span class="va">sample_information_region_choose</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">phenotype_simu</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"Background"</span></span>
<span><span class="va">Ground_truth</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">sample_information_region_choose</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/row.names.html" class="external-link">row.names</a></span><span class="op">(</span><span class="va">test_coordinate</span><span class="op">)</span><span class="op">]</span>, </span>
<span>                       levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">phenotype_simu</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="st">"Background"</span>, <span class="va">phenotype_simu</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">test_coordinate</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">X</span>, y <span class="op">=</span> <span class="va">Y</span>, color <span class="op">=</span> <span class="va">Ground_truth</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_color_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="va">custom_colors</span><span class="op">)</span></span></code></pre></div>
<p><img src="SpaPheno-tutorial_files/figure-html/unnamed-chunk-13-1.png" width="700" style="display: block; margin: auto;"></p>
</div>
<div class="section level3">
<h3 id="obtain-simulated-data-with-phenotypes">Obtain simulated data with phenotypes<a class="anchor" aria-label="anchor" href="#obtain-simulated-data-with-phenotypes"></a>
</h3>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pseudo_bulk_simi</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/generate_simulated_bulk_data.html">generate_simulated_bulk_data</a></span><span class="op">(</span></span>
<span>  input_data <span class="op">=</span> <span class="va">sample_information_cellType</span>, </span>
<span>  region_labels <span class="op">=</span> <span class="va">sample_information_region</span>, </span>
<span>  phenotypes <span class="op">=</span> <span class="va">phenotype_simu</span>, </span>
<span>  perturbation_percent <span class="op">=</span> <span class="fl">0.1</span>, </span>
<span>  num_samples <span class="op">=</span> <span class="fl">50</span>,</span>
<span>  mode <span class="op">=</span> <span class="st">"proportion"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">pseudo_bulk_df1</span> <span class="op">&lt;-</span> <span class="va">pseudo_bulk_simi</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="va">pseudo_bulk_df2</span> <span class="op">&lt;-</span> <span class="va">pseudo_bulk_simi</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span></span>
<span></span>
<span><span class="va">bulk_decon</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">pseudo_bulk_df1</span>, <span class="va">pseudo_bulk_df2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">bulk_decon</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">bulk_decon</span>, <span class="fl">2</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">x</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">bulk_pheno</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>, each <span class="op">=</span> <span class="fl">50</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">bulk_pheno</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">pseudo_bulk_df1</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">pseudo_bulk_df2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">family</span> <span class="op">&lt;-</span> <span class="st">"binomial"</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="obtain-prediction-results">Obtain prediction results<a class="anchor" aria-label="anchor" href="#obtain-prediction-results"></a>
</h3>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">PhenoResult</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/SpatialPhenoMap.html">SpatialPhenoMap</a></span><span class="op">(</span></span>
<span>  bulk_decon <span class="op">=</span> <span class="va">bulk_decon</span>,</span>
<span>  bulk_pheno <span class="op">=</span> <span class="va">bulk_pheno</span>, </span>
<span>  family <span class="op">=</span> <span class="va">family</span>, </span>
<span>  coord <span class="op">=</span> <span class="va">test_coordinate</span>, </span>
<span>  resolution <span class="op">=</span> <span class="st">"single_cell"</span>, </span>
<span>  sample_information_cellType <span class="op">=</span> <span class="va">sample_information_cellType</span>, </span>
<span>  n_perm <span class="op">=</span> <span class="fl">1</span>, </span>
<span>  p <span class="op">=</span> <span class="fl">0.001</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><img src="SpaPheno-tutorial_files/figure-html/unnamed-chunk-15-1.png" width="700" style="display: block; margin: auto;"><img src="SpaPheno-tutorial_files/figure-html/unnamed-chunk-15-2.png" width="700" style="display: block; margin: auto;"><img src="SpaPheno-tutorial_files/figure-html/unnamed-chunk-15-3.png" width="700" style="display: block; margin: auto;"></p>
</div>
</div>
<div class="section level2">
<h2 id="survival-hcc">Survival HCC<a class="anchor" aria-label="anchor" href="#survival-hcc"></a>
</h2>
<div class="section level3">
<h3 id="load-demo-data">load demo data<a class="anchor" aria-label="anchor" href="#load-demo-data"></a>
</h3>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/rm.html" class="external-link">rm</a></span><span class="op">(</span>list <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ls.html" class="external-link">ls</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/load.html" class="external-link">load</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>, <span class="st">"HCC_survival.RData"</span>, package <span class="op">=</span> <span class="st">"SpaPheno"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### TLS label</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">test_coordinate</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">X</span>, y <span class="op">=</span> <span class="va">Y</span>, color <span class="op">=</span> <span class="va">sample_information_region</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">1.5</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_color_manual</a></span><span class="op">(</span></span>
<span>    values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>      <span class="st">"TLS"</span> <span class="op">=</span> <span class="st">"#007ACC"</span>,   </span>
<span>      <span class="st">"nonTLS"</span> <span class="op">=</span> <span class="st">"lightgray"</span> </span>
<span>    <span class="op">)</span>,</span>
<span>    name <span class="op">=</span> <span class="st">"Region Type"</span>, </span>
<span>    labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Non-TLS"</span>, <span class="st">"TLS"</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<p><img src="SpaPheno-tutorial_files/figure-html/unnamed-chunk-16-1.png" width="700" style="display: block; margin: auto;"></p>
</div>
<div class="section level3">
<h3 id="obtain-prediction-results-1">Obtain prediction results<a class="anchor" aria-label="anchor" href="#obtain-prediction-results-1"></a>
</h3>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">PhenoResult</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/SpatialPhenoMap.html">SpatialPhenoMap</a></span><span class="op">(</span></span>
<span>  bulk_decon <span class="op">=</span> <span class="va">bulk_decon</span>,</span>
<span>  bulk_pheno <span class="op">=</span> <span class="va">bulk_pheno</span>,</span>
<span>  family <span class="op">=</span> <span class="st">"cox"</span>,</span>
<span>  coord <span class="op">=</span> <span class="va">test_coordinate</span>,</span>
<span>  resolution <span class="op">=</span> <span class="st">"spot"</span>,</span>
<span>  sample_information_decon <span class="op">=</span> <span class="va">ST_decon</span>,</span>
<span>  size <span class="op">=</span> <span class="fl">1.5</span>,</span>
<span>  n_perm <span class="op">=</span> <span class="fl">1</span>,</span>
<span>  p <span class="op">=</span> <span class="fl">0.001</span>,</span>
<span>  r <span class="op">=</span> <span class="fl">4</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><img src="SpaPheno-tutorial_files/figure-html/unnamed-chunk-17-1.png" width="700" style="display: block; margin: auto;"><img src="SpaPheno-tutorial_files/figure-html/unnamed-chunk-17-2.png" width="700" style="display: block; margin: auto;"><img src="SpaPheno-tutorial_files/figure-html/unnamed-chunk-17-3.png" width="700" style="display: block; margin: auto;"></p>
</div>
<div class="section level3">
<h3 id="shap-analysis-1">SHAP analysis<a class="anchor" aria-label="anchor" href="#shap-analysis-1"></a>
</h3>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pred_result</span> <span class="op">&lt;-</span> <span class="va">PhenoResult</span><span class="op">$</span><span class="va">pred_score</span></span>
<span><span class="va">phenoPlus</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/row.names.html" class="external-link">row.names</a></span><span class="op">(</span><span class="va">pred_result</span><span class="op">[</span><span class="va">pred_result</span><span class="op">$</span><span class="va">label</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="st">"phenotype+"</span>, <span class="op">]</span><span class="op">)</span></span>
<span><span class="va">phenoMinus</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/row.names.html" class="external-link">row.names</a></span><span class="op">(</span><span class="va">pred_result</span><span class="op">[</span><span class="va">pred_result</span><span class="op">$</span><span class="va">label</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="st">"phenotype-"</span>, <span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="va">model</span> <span class="op">&lt;-</span> <span class="va">PhenoResult</span><span class="op">$</span><span class="va">model</span></span>
<span><span class="va">X</span> <span class="op">&lt;-</span> <span class="va">PhenoResult</span><span class="op">$</span><span class="va">cell_type_distribution</span><span class="op">[</span><span class="va">phenoMinus</span>, <span class="op">]</span></span>
<span><span class="va">shap_test</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/compute_shap_spatial.html">compute_shap_spatial</a></span><span class="op">(</span><span class="va">model</span>, <span class="va">bulk_decon</span>, <span class="va">bulk_pheno</span>, <span class="va">X</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">shap_test</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##             feature           phi      phi.var feature.value             sample</span></span>
<span><span class="co">## 1        Bio.potent  0.0005838659 1.551781e-05   0.105472520 AAACAAGTATCTCCCA-1</span></span>
<span><span class="co">## 2               CAF -0.0435152693 1.767573e-03   0.119948046 AAACAAGTATCTCCCA-1</span></span>
<span><span class="co">## 3 CCL3L1.Macrophage  0.0000000000 0.000000e+00   0.005836406 AAACAAGTATCTCCCA-1</span></span>
<span><span class="co">## 4         CD8..MAIT -0.0197043006 3.004776e-04   0.009533719 AAACAAGTATCTCCCA-1</span></span>
<span><span class="co">## 5          CD8..Trm -0.0520022782 2.085855e-03   0.008196035 AAACAAGTATCTCCCA-1</span></span>
<span><span class="co">## 6           CD16.NK  0.0500187685 3.619665e-03   0.006682971 AAACAAGTATCTCCCA-1</span></span></code></pre>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/SpaPheno_SHAP_summary_plot.html">SpaPheno_SHAP_summary_plot</a></span><span class="op">(</span><span class="va">shap_test</span>, top_n <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></span></code></pre></div>
<p><img src="SpaPheno-tutorial_files/figure-html/unnamed-chunk-18-1.png" width="700" style="display: block; margin: auto;"></p>
</div>
<div class="section level3">
<h3 id="shap-residual-analysis-1">SHAP residual analysis<a class="anchor" aria-label="anchor" href="#shap-residual-analysis-1"></a>
</h3>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">resi_result</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/SpaPheno_SHAP_residual_analysis.html">SpaPheno_SHAP_residual_analysis</a></span><span class="op">(</span></span>
<span>  shap_df <span class="op">=</span> <span class="va">shap_test</span>,</span>
<span>  feature_name <span class="op">=</span> <span class="st">"Naive.CD4T"</span>,</span>
<span>  coordinate_df <span class="op">=</span> <span class="va">test_coordinate</span>, size <span class="op">=</span> <span class="fl">0.8</span></span>
<span><span class="op">)</span></span>
<span><span class="va">resi_result</span><span class="op">$</span><span class="va">dependence_plot</span></span></code></pre></div>
<p><img src="SpaPheno-tutorial_files/figure-html/unnamed-chunk-19-1.png" width="700" style="display: block; margin: auto;"></p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">resi_result</span><span class="op">$</span><span class="va">spatial_plot</span></span></code></pre></div>
<p><img src="SpaPheno-tutorial_files/figure-html/unnamed-chunk-19-2.png" width="700" style="display: block; margin: auto;"></p>
</div>
<div class="section level3">
<h3 id="shap-waterfall-plot">SHAP waterfall plot<a class="anchor" aria-label="anchor" href="#shap-waterfall-plot"></a>
</h3>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">resi_hot</span> <span class="op">&lt;-</span> <span class="va">resi_result</span><span class="op">$</span><span class="va">residual_table</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">resi_hot</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/order.html" class="external-link">order</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">resi_hot</span><span class="op">$</span><span class="va">phi_resid_z</span><span class="op">)</span>, decreasing <span class="op">=</span> <span class="cn">T</span><span class="op">)</span>, <span class="op">]</span>, <span class="fl">10</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##        feature        phi    phi.var feature.value             sample</span></span>
<span><span class="co">## 30  Naive.CD4T -0.5257900 0.13837004    0.04155390 AATTCCAACTTGGTGA-1</span></span>
<span><span class="co">## 51  Naive.CD4T -0.3821739 0.07231961    0.11206579 ACGACTCTAGGGCCGA-1</span></span>
<span><span class="co">## 474 Naive.CD4T -0.5322684 0.17930920    0.05231648 TTATATACGCTGTCAC-1</span></span>
<span><span class="co">## 420 Naive.CD4T -0.4955256 0.07926515    0.04394551 TCGCCTCGACCTGTTG-1</span></span>
<span><span class="co">## 453 Naive.CD4T -0.5082004 0.09662787    0.04816872 TGGACTGTTCGCTCAA-1</span></span>
<span><span class="co">## 181 Naive.CD4T -0.4916031 0.07350465    0.04604062 CGCATTAGCTAATAGG-1</span></span>
<span><span class="co">## 331 Naive.CD4T -0.4994501 0.11421113    0.05003514 GTACTAAGATTTGGAG-1</span></span>
<span><span class="co">## 136 Naive.CD4T -0.4456933 0.12689195    0.11926253 CAGGGCTAACGAAACC-1</span></span>
<span><span class="co">## 419 Naive.CD4T -0.3278083 0.07309902    0.08241027 TCGCCTCCTTCGGCTC-1</span></span>
<span><span class="co">## 379 Naive.CD4T -0.3405043 0.08242797    0.08543729 TAGCAGATACTTAGGG-1</span></span>
<span><span class="co">##     phi_residual phi_resid_z   resid_group color_group</span></span>
<span><span class="co">## 30    -0.1972143   -3.930519  Low residual         Low</span></span>
<span><span class="co">## 51     0.1790110    3.567723 High residual        High</span></span>
<span><span class="co">## 474   -0.1681884   -3.352028  Low residual         Low</span></span>
<span><span class="co">## 420   -0.1590603   -3.170102  Low residual         Low</span></span>
<span><span class="co">## 453   -0.1578033   -3.145050  Low residual         Low</span></span>
<span><span class="co">## 181   -0.1482263   -2.954179  Low residual         Low</span></span>
<span><span class="co">## 331   -0.1428959   -2.847942  Low residual         Low</span></span>
<span><span class="co">## 136    0.1392326    2.774932 High residual        High</span></span>
<span><span class="co">## 419    0.1355471    2.701479 High residual        High</span></span>
<span><span class="co">## 379    0.1328367    2.647461 High residual        High</span></span></code></pre>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/SpaPheno_SHAP_waterfall_plot.html">SpaPheno_SHAP_waterfall_plot</a></span><span class="op">(</span><span class="va">shap_test</span>, <span class="st">"TCGCCGGAGAGTCTTA-1"</span>, top_n <span class="op">=</span> <span class="fl">48</span><span class="op">)</span></span></code></pre></div>
<p><img src="SpaPheno-tutorial_files/figure-html/unnamed-chunk-20-1.png" width="700" style="display: block; margin: auto;"></p>
</div>
<div class="section level3">
<h3 id="shap-dependence-plot">SHAP dependence plot<a class="anchor" aria-label="anchor" href="#shap-dependence-plot"></a>
</h3>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">TCell_subtypes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">shap_test</span><span class="op">$</span><span class="va">feature</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_detect.html" class="external-link">str_detect</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">shap_test</span><span class="op">$</span><span class="va">feature</span><span class="op">)</span>, <span class="st">"CD.T"</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="va">BCell_subtypes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">shap_test</span><span class="op">$</span><span class="va">feature</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_detect.html" class="external-link">str_detect</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">shap_test</span><span class="op">$</span><span class="va">feature</span><span class="op">)</span>, <span class="st">"BCell"</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="va">Monocyte_subtypes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">shap_test</span><span class="op">$</span><span class="va">feature</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_detect.html" class="external-link">str_detect</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">shap_test</span><span class="op">$</span><span class="va">feature</span><span class="op">)</span>, <span class="st">"Monocyte"</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="va">Macrophage_subtypes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">shap_test</span><span class="op">$</span><span class="va">feature</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_detect.html" class="external-link">str_detect</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">shap_test</span><span class="op">$</span><span class="va">feature</span><span class="op">)</span>, <span class="st">"Macrophage"</span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span><span class="fu"><a href="../reference/SpaPheno_SHAP_dependence_plot.html">SpaPheno_SHAP_dependence_plot</a></span><span class="op">(</span><span class="va">shap_test</span>, <span class="va">TCell_subtypes</span><span class="op">)</span></span></code></pre></div>
<p><img src="SpaPheno-tutorial_files/figure-html/unnamed-chunk-21-1.png" width="700" style="display: block; margin: auto;"></p>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/SpaPheno_SHAP_dependence_plot.html">SpaPheno_SHAP_dependence_plot</a></span><span class="op">(</span><span class="va">shap_test</span>, <span class="va">BCell_subtypes</span><span class="op">)</span></span></code></pre></div>
<p><img src="SpaPheno-tutorial_files/figure-html/unnamed-chunk-21-2.png" width="700" style="display: block; margin: auto;"></p>
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/SpaPheno_SHAP_dependence_plot.html">SpaPheno_SHAP_dependence_plot</a></span><span class="op">(</span><span class="va">shap_test</span>, <span class="va">Monocyte_subtypes</span><span class="op">)</span></span></code></pre></div>
<p><img src="SpaPheno-tutorial_files/figure-html/unnamed-chunk-21-3.png" width="700" style="display: block; margin: auto;"></p>
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/SpaPheno_SHAP_dependence_plot.html">SpaPheno_SHAP_dependence_plot</a></span><span class="op">(</span><span class="va">shap_test</span>, <span class="va">Macrophage_subtypes</span><span class="op">)</span></span></code></pre></div>
<p><img src="SpaPheno-tutorial_files/figure-html/unnamed-chunk-21-4.png" width="700" style="display: block; margin: auto;"></p>
</div>
</div>
<div class="section level2">
<h2 id="survival-brca">Survival BRCA<a class="anchor" aria-label="anchor" href="#survival-brca"></a>
</h2>
<div class="section level3">
<h3 id="load-demo-data-1">load demo data<a class="anchor" aria-label="anchor" href="#load-demo-data-1"></a>
</h3>
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/rm.html" class="external-link">rm</a></span><span class="op">(</span>list <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ls.html" class="external-link">ls</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/load.html" class="external-link">load</a></span><span class="op">(</span><span class="st">"BRCAsurvival.RData"</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">### survival phenotype</span></span>
<span><span class="va">TCGA_survival_each</span> <span class="op">&lt;-</span> <span class="va">TCGA_BRCA</span><span class="op">$</span><span class="va">TCGA.BRCA.survival.tsv</span></span>
<span><span class="va">Survival_TCGA_choose</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="va">TCGA_survival_each</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/row.names.html" class="external-link">row.names</a></span><span class="op">(</span><span class="va">Survival_TCGA_choose</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">Survival_TCGA_choose</span><span class="op">[</span>, <span class="fl">1</span><span class="op">]</span></span>
<span></span>
<span><span class="co">### common samples between survival phenotype and deconvolution</span></span>
<span><span class="va">sample_information_decon_TCGA_choose</span> <span class="op">&lt;-</span> <span class="va">BRCA_decon</span><span class="op">[</span><span class="fu"><a href="https://generics.r-lib.org/reference/setops.html" class="external-link">intersect</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="va">TCGA_survival_each</span><span class="op">)</span><span class="op">[</span>, <span class="fl">1</span><span class="op">]</span>, <span class="fu"><a href="https://rdrr.io/r/base/row.names.html" class="external-link">row.names</a></span><span class="op">(</span><span class="va">BRCA_decon</span><span class="op">)</span><span class="op">)</span>, <span class="op">]</span></span>
<span><span class="va">Survival_TCGA_choose</span> <span class="op">&lt;-</span> <span class="va">Survival_TCGA_choose</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/row.names.html" class="external-link">row.names</a></span><span class="op">(</span><span class="va">sample_information_decon_TCGA_choose</span><span class="op">)</span>, <span class="op">]</span></span>
<span></span>
<span><span class="co">### survival object</span></span>
<span><span class="va">surv_obj</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html" class="external-link">Surv</a></span><span class="op">(</span><span class="va">Survival_TCGA_choose</span><span class="op">$</span><span class="va">OS.time</span>, <span class="va">Survival_TCGA_choose</span><span class="op">$</span><span class="va">OS</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### ST</span></span>
<span><span class="va">test_coordinate</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">BRCA_ST</span><span class="op">$</span><span class="va">x</span>, <span class="va">BRCA_ST</span><span class="op">$</span><span class="va">y</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">test_coordinate</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"X"</span>, <span class="st">"Y"</span><span class="op">)</span></span>
<span><span class="va">sample_information_region</span> <span class="op">&lt;-</span> <span class="va">BRCA_ST</span><span class="op">$</span><span class="va">label</span></span>
<span><span class="va">bulk_decon</span> <span class="op">&lt;-</span> <span class="va">sample_information_decon_TCGA_choose</span></span>
<span><span class="va">bulk_pheno</span> <span class="op">&lt;-</span> <span class="va">surv_obj</span></span>
<span><span class="va">family</span> <span class="op">&lt;-</span> <span class="st">"cox"</span></span>
<span></span>
<span><span class="va">coord</span> <span class="op">&lt;-</span> <span class="va">test_coordinate</span></span>
<span><span class="va">resolution</span> <span class="op">&lt;-</span> <span class="st">"spot"</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">bulk_decon</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">gsub</a></span><span class="op">(</span><span class="st">"^[^_]*_[^_]*_[^_]*_sf_"</span>, <span class="st">""</span>, <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">bulk_decon</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">sample_information_decon</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">gsub</a></span><span class="op">(</span><span class="st">"^[^_]*_[^_]*_[^_]*_sf_"</span>, <span class="st">""</span>, <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">sample_information_decon</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="ground-truth">Ground truth<a class="anchor" aria-label="anchor" href="#ground-truth"></a>
</h3>
<div class="sourceCode" id="cb39"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">test_coordinate</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">X</span>, y <span class="op">=</span> <span class="va">Y</span>, color <span class="op">=</span> <span class="va">sample_information_region</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">4</span><span class="op">)</span></span></code></pre></div>
<p><img src="SpaPheno-tutorial_files/figure-html/unnamed-chunk-24-1.png" width="700" style="display: block; margin: auto;"></p>
</div>
<div class="section level3">
<h3 id="obtain-predicion-results">Obtain predicion results<a class="anchor" aria-label="anchor" href="#obtain-predicion-results"></a>
</h3>
<div class="sourceCode" id="cb40"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">PhenoResult</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/SpatialPhenoMap.html">SpatialPhenoMap</a></span><span class="op">(</span></span>
<span>  bulk_decon <span class="op">=</span> <span class="va">bulk_decon</span>, </span>
<span>  bulk_pheno <span class="op">=</span> <span class="va">bulk_pheno</span>, </span>
<span>  family <span class="op">=</span> <span class="st">"cox"</span>, </span>
<span>  coord <span class="op">=</span> <span class="va">test_coordinate</span>, </span>
<span>  resolution <span class="op">=</span> <span class="st">"spot"</span>, </span>
<span>  sample_information_decon <span class="op">=</span> <span class="va">sample_information_decon</span>,</span>
<span>  size <span class="op">=</span> <span class="fl">5</span>, </span>
<span>  n_perm <span class="op">=</span> <span class="fl">1</span>, </span>
<span>  p <span class="op">=</span> <span class="fl">0.001</span>, </span>
<span>  r <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<p><img src="SpaPheno-tutorial_files/figure-html/unnamed-chunk-25-1.png" width="700" style="display: block; margin: auto;"><img src="SpaPheno-tutorial_files/figure-html/unnamed-chunk-25-2.png" width="700" style="display: block; margin: auto;"><img src="SpaPheno-tutorial_files/figure-html/unnamed-chunk-25-3.png" width="700" style="display: block; margin: auto;"></p>
</div>
</div>
<div class="section level2">
<h2 id="survival-kirc">Survival KIRC<a class="anchor" aria-label="anchor" href="#survival-kirc"></a>
</h2>
<div class="section level3">
<h3 id="load-demo-data-2">load demo data<a class="anchor" aria-label="anchor" href="#load-demo-data-2"></a>
</h3>
<div class="sourceCode" id="cb41"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/rm.html" class="external-link">rm</a></span><span class="op">(</span>list <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ls.html" class="external-link">ls</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/load.html" class="external-link">load</a></span><span class="op">(</span><span class="st">"KIRC_survival.RData"</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb42"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">### survival phenotype</span></span>
<span><span class="va">TCGA_survival_each</span> <span class="op">&lt;-</span> <span class="va">TCGA_KIRC</span><span class="op">$</span><span class="va">TCGA.KIRC.survival.tsv</span></span>
<span><span class="va">Survival_TCGA_choose</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="va">TCGA_survival_each</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/row.names.html" class="external-link">row.names</a></span><span class="op">(</span><span class="va">Survival_TCGA_choose</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">Survival_TCGA_choose</span><span class="op">[</span>, <span class="fl">1</span><span class="op">]</span></span>
<span></span>
<span><span class="co">### common samples between survival phenotype and deconvolution</span></span>
<span><span class="va">sample_information_decon_TCGA_choose</span> <span class="op">&lt;-</span> <span class="va">KIRC_decon</span><span class="op">[</span><span class="fu"><a href="https://generics.r-lib.org/reference/setops.html" class="external-link">intersect</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="va">TCGA_survival_each</span><span class="op">)</span><span class="op">[</span>, <span class="fl">1</span><span class="op">]</span>, <span class="fu"><a href="https://rdrr.io/r/base/row.names.html" class="external-link">row.names</a></span><span class="op">(</span><span class="va">KIRC_decon</span><span class="op">)</span><span class="op">)</span>, <span class="op">]</span></span>
<span><span class="va">Survival_TCGA_choose</span> <span class="op">&lt;-</span> <span class="va">Survival_TCGA_choose</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/row.names.html" class="external-link">row.names</a></span><span class="op">(</span><span class="va">sample_information_decon_TCGA_choose</span><span class="op">)</span>, <span class="op">]</span></span>
<span></span>
<span><span class="co">### survival object</span></span>
<span><span class="va">surv_obj</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html" class="external-link">Surv</a></span><span class="op">(</span><span class="va">Survival_TCGA_choose</span><span class="op">$</span><span class="va">OS.time</span>, <span class="va">Survival_TCGA_choose</span><span class="op">$</span><span class="va">OS</span><span class="op">)</span></span>
<span></span>
<span><span class="va">test_coordinate</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">KIRC_ST</span><span class="op">$</span><span class="va">x</span>, <span class="va">KIRC_ST</span><span class="op">$</span><span class="va">y</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">test_coordinate</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"X"</span>, <span class="st">"Y"</span><span class="op">)</span></span>
<span><span class="va">sample_information_region</span> <span class="op">&lt;-</span> <span class="va">KIRC_ST</span><span class="op">$</span><span class="va">TLSanno</span></span>
<span><span class="va">bulk_decon</span> <span class="op">&lt;-</span> <span class="va">sample_information_decon_TCGA_choose</span></span>
<span><span class="va">bulk_pheno</span> <span class="op">&lt;-</span> <span class="va">surv_obj</span></span>
<span><span class="va">family</span> <span class="op">&lt;-</span> <span class="st">"cox"</span></span>
<span></span>
<span><span class="va">coord</span> <span class="op">&lt;-</span> <span class="va">test_coordinate</span></span>
<span><span class="va">resolution</span> <span class="op">&lt;-</span> <span class="st">"spot"</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">bulk_decon</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">gsub</a></span><span class="op">(</span><span class="st">"^[^_]*_[^_]*_[^_]*_sf_"</span>, <span class="st">""</span>, <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">bulk_decon</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">sample_information_decon</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">gsub</a></span><span class="op">(</span><span class="st">"^[^_]*_[^_]*_[^_]*_sf_"</span>, <span class="st">""</span>, <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">sample_information_decon</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="ground-truth-1">Ground Truth<a class="anchor" aria-label="anchor" href="#ground-truth-1"></a>
</h3>
<div class="sourceCode" id="cb43"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">test_coordinate</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">X</span>, y <span class="op">=</span> <span class="va">Y</span>, color <span class="op">=</span> <span class="va">sample_information_region</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_color_manual</a></span><span class="op">(</span></span>
<span>    values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>      <span class="st">"TLS"</span> <span class="op">=</span> <span class="st">"#007ACC"</span>,</span>
<span>      <span class="st">"NO_TLS"</span> <span class="op">=</span> <span class="st">"lightgray"</span></span>
<span>    <span class="op">)</span>,</span>
<span>    name <span class="op">=</span> <span class="st">"Region Type"</span>,</span>
<span>    labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"NO_TLS"</span>, <span class="st">"TLS"</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<p><img src="SpaPheno-tutorial_files/figure-html/unnamed-chunk-28-1.png" width="700" style="display: block; margin: auto;"></p>
</div>
<div class="section level3">
<h3 id="prediction-result">Prediction result<a class="anchor" aria-label="anchor" href="#prediction-result"></a>
</h3>
<div class="sourceCode" id="cb44"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">PhenoResult</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/SpatialPhenoMap.html">SpatialPhenoMap</a></span><span class="op">(</span></span>
<span>  bulk_decon <span class="op">=</span> <span class="va">bulk_decon</span>,</span>
<span>  bulk_pheno <span class="op">=</span> <span class="va">bulk_pheno</span>, </span>
<span>  family <span class="op">=</span> <span class="va">family</span>, </span>
<span>  coord <span class="op">=</span> <span class="va">test_coordinate</span>, </span>
<span>  resolution <span class="op">=</span> <span class="st">"spot"</span>, </span>
<span>  sample_information_decon <span class="op">=</span> <span class="va">sample_information_decon</span>, </span>
<span>  size <span class="op">=</span> <span class="fl">1.5</span>, </span>
<span>  n_perm <span class="op">=</span> <span class="fl">1</span>, </span>
<span>  p <span class="op">=</span> <span class="fl">0.005</span>, </span>
<span>  r <span class="op">=</span> <span class="fl">2</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><img src="SpaPheno-tutorial_files/figure-html/unnamed-chunk-29-1.png" width="700" style="display: block; margin: auto;"><img src="SpaPheno-tutorial_files/figure-html/unnamed-chunk-29-2.png" width="700" style="display: block; margin: auto;"><img src="SpaPheno-tutorial_files/figure-html/unnamed-chunk-29-3.png" width="700" style="display: block; margin: auto;"></p>
</div>
<div class="section level3">
<h3 id="hclust-of-low-risk-region">Hclust of low risk region<a class="anchor" aria-label="anchor" href="#hclust-of-low-risk-region"></a>
</h3>
<div class="sourceCode" id="cb45"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/PhenotypeHclust.html">PhenotypeHclust</a></span><span class="op">(</span><span class="va">PhenoResult</span>, <span class="st">"phenotype-"</span>, <span class="va">test_coordinate</span>, size <span class="op">=</span> <span class="fl">1.5</span><span class="op">)</span></span></code></pre></div>
<p><img src="SpaPheno-tutorial_files/figure-html/unnamed-chunk-30-1.png" width="700" style="display: block; margin: auto;"><img src="SpaPheno-tutorial_files/figure-html/unnamed-chunk-30-2.png" width="700" style="display: block; margin: auto;"><img src="SpaPheno-tutorial_files/figure-html/unnamed-chunk-30-3.png" width="700" style="display: block; margin: auto;"><img src="SpaPheno-tutorial_files/figure-html/unnamed-chunk-30-4.png" width="700" style="display: block; margin: auto;"></p>
</div>
</div>
<div class="section level2">
<h2 id="stage-hcc">Stage HCC<a class="anchor" aria-label="anchor" href="#stage-hcc"></a>
</h2>
<div class="section level3">
<h3 id="load-data-2">load data<a class="anchor" aria-label="anchor" href="#load-data-2"></a>
</h3>
<div class="sourceCode" id="cb46"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/rm.html" class="external-link">rm</a></span><span class="op">(</span>list <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ls.html" class="external-link">ls</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/load.html" class="external-link">load</a></span><span class="op">(</span><span class="st">"HCC_stage.RData"</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb47"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#### common samples between stage phenotype and deconvolution</span></span>
<span><span class="va">common_sample</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://generics.r-lib.org/reference/setops.html" class="external-link">intersect</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">sample_information_stage</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/row.names.html" class="external-link">row.names</a></span><span class="op">(</span><span class="va">LIHC_decon</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">LIHC_decon</span> <span class="op">&lt;-</span> <span class="va">LIHC_decon</span><span class="op">[</span><span class="va">common_sample</span>, <span class="op">]</span></span>
<span><span class="va">sample_information_stage</span> <span class="op">&lt;-</span> <span class="va">sample_information_stage</span><span class="op">[</span><span class="va">common_sample</span><span class="op">]</span></span>
<span></span>
<span></span>
<span><span class="va">sample_information_region</span> <span class="op">&lt;-</span> <span class="va">HCC_ST</span><span class="op">$</span><span class="va">TLSanno</span></span>
<span><span class="va">test_coordinate</span> <span class="op">&lt;-</span> <span class="va">HCC_ST</span><span class="op">@</span><span class="va">meta.data</span><span class="op">[</span>, <span class="fl">4</span><span class="op">:</span><span class="fl">5</span><span class="op">]</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">test_coordinate</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"X"</span>, <span class="st">"Y"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">bulk_decon</span> <span class="op">&lt;-</span> <span class="va">LIHC_decon</span></span>
<span><span class="va">bulk_pheno</span> <span class="op">&lt;-</span> <span class="va">sample_information_stage</span></span>
<span><span class="va">family</span> <span class="op">&lt;-</span> <span class="st">"gaussian"</span></span>
<span></span>
<span><span class="va">coord</span> <span class="op">&lt;-</span> <span class="va">test_coordinate</span></span>
<span><span class="va">resolution</span> <span class="op">&lt;-</span> <span class="st">"spot"</span></span>
<span><span class="va">sample_information_decon</span> <span class="op">&lt;-</span> <span class="va">sample_information_decon</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">bulk_decon</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">gsub</a></span><span class="op">(</span><span class="st">"^[^_]*_[^_]*_[^_]*_sf_"</span>, <span class="st">""</span>, <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">bulk_decon</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">sample_information_decon</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">gsub</a></span><span class="op">(</span><span class="st">"^[^_]*_[^_]*_[^_]*_sf_"</span>, <span class="st">""</span>, <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">sample_information_decon</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### TLS label</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">test_coordinate</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">X</span>, y <span class="op">=</span> <span class="va">Y</span>, color <span class="op">=</span> <span class="va">sample_information_region</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">1.5</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_color_manual</a></span><span class="op">(</span></span>
<span>    values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>      <span class="st">"TLS"</span> <span class="op">=</span> <span class="st">"#007ACC"</span>, </span>
<span>      <span class="st">"nonTLS"</span> <span class="op">=</span> <span class="st">"lightgray"</span> </span>
<span>    <span class="op">)</span>,</span>
<span>    name <span class="op">=</span> <span class="st">"Region Type"</span>,</span>
<span>    labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Non-TLS"</span>, <span class="st">"TLS"</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<p><img src="SpaPheno-tutorial_files/figure-html/unnamed-chunk-32-1.png" width="700" style="display: block; margin: auto;"></p>
</div>
<div class="section level3">
<h3 id="obtain-prdiction-result">Obtain prdiction result<a class="anchor" aria-label="anchor" href="#obtain-prdiction-result"></a>
</h3>
<div class="sourceCode" id="cb48"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">PhenoResult</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/SpatialPhenoMap.html">SpatialPhenoMap</a></span><span class="op">(</span></span>
<span>  bulk_decon <span class="op">=</span> <span class="va">bulk_decon</span>,</span>
<span>  bulk_pheno <span class="op">=</span> <span class="va">bulk_pheno</span>,</span>
<span>  family <span class="op">=</span> <span class="va">family</span>,</span>
<span>  coord <span class="op">=</span> <span class="va">test_coordinate</span>,</span>
<span>  resolution <span class="op">=</span> <span class="st">"spot"</span>, </span>
<span>  sample_information_decon <span class="op">=</span> <span class="va">sample_information_decon</span>, </span>
<span>  size <span class="op">=</span> <span class="fl">1.5</span>, </span>
<span>  n_perm <span class="op">=</span> <span class="fl">1</span>, </span>
<span>  p <span class="op">=</span> <span class="fl">0.001</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><img src="SpaPheno-tutorial_files/figure-html/unnamed-chunk-33-1.png" width="700" style="display: block; margin: auto;"><img src="SpaPheno-tutorial_files/figure-html/unnamed-chunk-33-2.png" width="700" style="display: block; margin: auto;"><img src="SpaPheno-tutorial_files/figure-html/unnamed-chunk-33-3.png" width="700" style="display: block; margin: auto;"></p>
</div>
</div>
<div class="section level2">
<h2 id="icb-melanoma">ICB melanoma<a class="anchor" aria-label="anchor" href="#icb-melanoma"></a>
</h2>
<div class="section level3">
<h3 id="load-data-3">load data<a class="anchor" aria-label="anchor" href="#load-data-3"></a>
</h3>
<div class="sourceCode" id="cb49"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/rm.html" class="external-link">rm</a></span><span class="op">(</span>list <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ls.html" class="external-link">ls</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/load.html" class="external-link">load</a></span><span class="op">(</span><span class="st">"Melanoma_ICB.RData"</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb50"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">test_coordinate</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">Melanoma_ST</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">Melanoma_ST</span><span class="op">$</span><span class="va">x</span><span class="op">)</span><span class="op">)</span><span class="op">[</span>, <span class="fl">4</span><span class="op">:</span><span class="fl">5</span><span class="op">]</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">test_coordinate</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Y"</span>, <span class="st">"X"</span><span class="op">)</span></span>
<span><span class="va">test_coordinate</span> <span class="op">&lt;-</span> <span class="va">test_coordinate</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"X"</span>, <span class="st">"Y"</span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span><span class="va">bulk_decon</span> <span class="op">&lt;-</span> <span class="va">bulk_decon</span></span>
<span><span class="va">bulk_pheno</span> <span class="op">&lt;-</span> <span class="va">bulk_pheno</span></span>
<span><span class="va">family</span> <span class="op">&lt;-</span> <span class="st">"binomial"</span></span>
<span></span>
<span><span class="va">coord</span> <span class="op">&lt;-</span> <span class="va">test_coordinate</span></span>
<span><span class="va">resolution</span> <span class="op">&lt;-</span> <span class="st">"spot"</span></span>
<span><span class="va">sample_information_decon</span> <span class="op">&lt;-</span> <span class="va">Melanoma_ST_decon</span></span>
<span><span class="co"># sample_information_decon&lt;-t(apply(sample_information_decon,1,function(x){x/sum(x)}))</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">bulk_decon</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">gsub</a></span><span class="op">(</span><span class="st">"^[^_]*_[^_]*_[^_]*_sf_"</span>, <span class="st">""</span>, <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">bulk_decon</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">sample_information_decon</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">gsub</a></span><span class="op">(</span><span class="st">"^[^_]*_[^_]*_[^_]*_sf_"</span>, <span class="st">""</span>, <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">sample_information_decon</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="obtain-predicion-results-1">Obtain predicion results<a class="anchor" aria-label="anchor" href="#obtain-predicion-results-1"></a>
</h3>
<div class="sourceCode" id="cb51"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">PhenoResult</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/SpatialPhenoMap.html">SpatialPhenoMap</a></span><span class="op">(</span></span>
<span>  bulk_decon <span class="op">=</span> <span class="va">bulk_decon</span>, </span>
<span>  bulk_pheno <span class="op">=</span> <span class="va">bulk_pheno</span>, </span>
<span>  family <span class="op">=</span> <span class="va">family</span>, </span>
<span>  coord <span class="op">=</span> <span class="va">test_coordinate</span>, </span>
<span>  resolution <span class="op">=</span> <span class="st">"spot"</span>, </span>
<span>  sample_information_decon <span class="op">=</span> <span class="va">sample_information_decon</span>, </span>
<span>  size <span class="op">=</span> <span class="fl">5</span>,</span>
<span>  n_perm <span class="op">=</span> <span class="fl">1</span>,</span>
<span>  p <span class="op">=</span> <span class="fl">0.01</span><span class="op">)</span></span></code></pre></div>
<p><img src="SpaPheno-tutorial_files/figure-html/unnamed-chunk-36-1.png" width="700" style="display: block; margin: auto;"><img src="SpaPheno-tutorial_files/figure-html/unnamed-chunk-36-2.png" width="700" style="display: block; margin: auto;"><img src="SpaPheno-tutorial_files/figure-html/unnamed-chunk-36-3.png" width="700" style="display: block; margin: auto;"></p>
</div>
</div>
<div class="section level2">
<h2 id="summary">Summary<a class="anchor" aria-label="anchor" href="#summary"></a>
</h2>
<p>This tutorial provides a step-by-step demonstration of how to apply
the <strong>SpaPheno</strong> R package to predict and interpret
spatially informed phenotypes using spatial transcriptomic and bulk-like
simulated data.</p>
<p>Across multiple datasets and biological contexts—including
<strong>simulated osmFISH and STARmap</strong>, and real-world
<strong>HCC, BRCA, and KIRC</strong> samples—this guide illustrates the
core capabilities of SpaPheno:</p>
<ul>
<li>
<strong>Phenotype Simulation</strong>: It shows how to simulate
bulk-like phenotypic data from spatial single-cell annotations,
capturing cell-type composition per region.</li>
<li>
<strong>Model Building</strong>: Using a logistic, linear, or Cox
proportional hazards model with automated alpha selection, SpaPheno
learns a predictive model from bulk deconvolution data and phenotypic
labels.</li>
<li>
<strong>Spatial Prediction</strong>: The model is applied back to
spatial neighborhoods (either at spot or single-cell resolution) to
estimate and visualize spatial risk distributions.</li>
<li>
<strong>Permutation Testing</strong>: The tool quantifies the
significance of spatial predictions using randomized coordinate-based
permutation testing.</li>
<li>
<strong>SHAP-based Interpretation</strong>: By leveraging SHAP
(SHapley Additive exPlanations), SpaPheno identifies the most important
cell types contributing to spatial phenotype risk, at both population
and single-cell levels.</li>
<li>
<strong>Residual &amp; Dependence Analysis</strong>: SpaPheno offers
residual maps and dependence plots to explore non-modeled effects and
spatial patterns, enhancing interpretability.</li>
</ul>
<p>In essence, <strong>SpaPheno bridges spatial cellular architecture
and clinical or experimental phenotypes</strong>, enabling researchers
to map spatial risk, decode key microenvironmental drivers, and explore
the mechanistic underpinnings of tissue-level phenotypes.</p>
<p>This reproducible tutorial serves as a valuable resource for both
method developers and biological researchers aiming to explore the
spatial origins of complex phenotypes.</p>
</div>
<div class="section level2">
<h2 id="system-information">System information<a class="anchor" aria-label="anchor" href="#system-information"></a>
</h2>
<div class="sourceCode" id="cb52"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/sessionInfo.html" class="external-link">sessionInfo</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## R version 4.4.3 (2025-02-28)</span></span>
<span><span class="co">## Platform: aarch64-apple-darwin20</span></span>
<span><span class="co">## Running under: macOS Sequoia 15.6</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Matrix products: default</span></span>
<span><span class="co">## BLAS:   /Library/Frameworks/R.framework/Versions/4.4-arm64/Resources/lib/libRblas.0.dylib </span></span>
<span><span class="co">## LAPACK: /Library/Frameworks/R.framework/Versions/4.4-arm64/Resources/lib/libRlapack.dylib;  LAPACK version 3.12.0</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## locale:</span></span>
<span><span class="co">## [1] en_US.UTF-8/en_US.UTF-8/en_US.UTF-8/C/en_US.UTF-8/en_US.UTF-8</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## time zone: Asia/Shanghai</span></span>
<span><span class="co">## tzcode source: internal</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## attached base packages:</span></span>
<span><span class="co">## [1] stats     graphics  grDevices utils     datasets  methods   base     </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## other attached packages:</span></span>
<span><span class="co">##  [1] umap_0.2.10.0       fastcluster_1.2.6   philentropy_0.9.0  </span></span>
<span><span class="co">##  [4] Seurat_5.3.0        SeuratObject_5.0.2  sp_2.2-0           </span></span>
<span><span class="co">##  [7] survival_3.8-3      reshape2_1.4.4      lubridate_1.9.4    </span></span>
<span><span class="co">## [10] forcats_1.0.0       stringr_1.5.1       dplyr_1.1.4        </span></span>
<span><span class="co">## [13] purrr_1.0.4         readr_2.1.5         tidyr_1.3.1        </span></span>
<span><span class="co">## [16] tibble_3.3.0        ggplot2_3.5.2       tidyverse_2.0.0    </span></span>
<span><span class="co">## [19] SpaPheno_0.0.1      BiocManager_1.30.25 BiocStyle_2.34.0   </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## loaded via a namespace (and not attached):</span></span>
<span><span class="co">##   [1] RcppAnnoy_0.0.22       splines_4.4.3          later_1.4.1           </span></span>
<span><span class="co">##   [4] polyclip_1.10-7        hardhat_1.4.1          pROC_1.18.5           </span></span>
<span><span class="co">##   [7] rpart_4.1.24           fastDummies_1.7.5      lifecycle_1.0.4       </span></span>
<span><span class="co">##  [10] globals_0.16.3         lattice_0.22-6         MASS_7.3-64           </span></span>
<span><span class="co">##  [13] backports_1.5.0        magrittr_2.0.3         plotly_4.10.4         </span></span>
<span><span class="co">##  [16] sass_0.4.9             rmarkdown_2.29         jquerylib_0.1.4       </span></span>
<span><span class="co">##  [19] yaml_2.3.10            httpuv_1.6.15          sctransform_0.4.1     </span></span>
<span><span class="co">##  [22] askpass_1.2.1          spam_2.11-1            spatstat.sparse_3.1-0 </span></span>
<span><span class="co">##  [25] reticulate_1.42.0      cowplot_1.1.3          pbapply_1.7-2         </span></span>
<span><span class="co">##  [28] RColorBrewer_1.1-3     abind_1.4-8            Rtsne_0.17            </span></span>
<span><span class="co">##  [31] Metrics_0.1.4          nnet_7.3-20            ipred_0.9-15          </span></span>
<span><span class="co">##  [34] lava_1.8.1             ggrepel_0.9.6          irlba_2.3.5.1         </span></span>
<span><span class="co">##  [37] listenv_0.9.1          spatstat.utils_3.1-3   goftest_1.2-3         </span></span>
<span><span class="co">##  [40] RSpectra_0.16-2        spatstat.random_3.3-3  fitdistrplus_1.2-2    </span></span>
<span><span class="co">##  [43] parallelly_1.43.0      pkgdown_2.1.1          codetools_0.2-20      </span></span>
<span><span class="co">##  [46] tidyselect_1.2.1       shape_1.4.6.1          farver_2.1.2          </span></span>
<span><span class="co">##  [49] viridis_0.6.5          matrixStats_1.5.0      stats4_4.4.3          </span></span>
<span><span class="co">##  [52] spatstat.explore_3.4-2 jsonlite_2.0.0         caret_7.0-1           </span></span>
<span><span class="co">##  [55] progressr_0.15.1       ggridges_0.5.6         iterators_1.0.14      </span></span>
<span><span class="co">##  [58] systemfonts_1.2.1      foreach_1.5.2          tools_4.4.3           </span></span>
<span><span class="co">##  [61] ragg_1.3.3             ica_1.0-3              Rcpp_1.0.14           </span></span>
<span><span class="co">##  [64] glue_1.8.0             prodlim_2024.06.25     gridExtra_2.3         </span></span>
<span><span class="co">##  [67] xfun_0.51              mgcv_1.9-1             withr_3.0.2           </span></span>
<span><span class="co">##  [70] fastmap_1.2.0          iml_0.11.4             openssl_2.3.2         </span></span>
<span><span class="co">##  [73] digest_0.6.37          timechange_0.3.0       R6_2.6.1              </span></span>
<span><span class="co">##  [76] mime_0.13              textshaping_1.0.0      colorspace_2.1-1      </span></span>
<span><span class="co">##  [79] scattermore_1.2        tensor_1.5             spatstat.data_3.1-6   </span></span>
<span><span class="co">##  [82] generics_0.1.3         data.table_1.17.0      recipes_1.2.0         </span></span>
<span><span class="co">##  [85] FNN_1.1.4.1            class_7.3-23           httr_1.4.7            </span></span>
<span><span class="co">##  [88] htmlwidgets_1.6.4      uwot_0.2.3             ModelMetrics_1.2.2.2  </span></span>
<span><span class="co">##  [91] pkgconfig_2.0.3        gtable_0.3.6           timeDate_4041.110     </span></span>
<span><span class="co">##  [94] lmtest_0.9-40          htmltools_0.5.8.1      dotCall64_1.2         </span></span>
<span><span class="co">##  [97] bookdown_0.42          scales_1.3.0           png_0.1-8             </span></span>
<span><span class="co">## [100] gower_1.0.2            spatstat.univar_3.1-2  knitr_1.50            </span></span>
<span><span class="co">## [103] rstudioapi_0.17.1      tzdb_0.5.0             checkmate_2.3.2       </span></span>
<span><span class="co">## [106] nlme_3.1-167           cachem_1.1.0           zoo_1.8-13            </span></span>
<span><span class="co">## [109] SpaDo_1.2.0            KernSmooth_2.23-26     parallel_4.4.3        </span></span>
<span><span class="co">## [112] miniUI_0.1.1.1         desc_1.4.3             pillar_1.10.1         </span></span>
<span><span class="co">## [115] grid_4.4.3             vctrs_0.6.5            RANN_2.6.2            </span></span>
<span><span class="co">## [118] promises_1.3.2         xtable_1.8-4           cluster_2.1.8         </span></span>
<span><span class="co">## [121] evaluate_1.0.3         cli_3.6.4              compiler_4.4.3        </span></span>
<span><span class="co">## [124] rlang_1.1.6            future.apply_1.11.3    labeling_0.4.3        </span></span>
<span><span class="co">## [127] plyr_1.8.9             fs_1.6.5               stringi_1.8.4         </span></span>
<span><span class="co">## [130] deldir_2.0-4           viridisLite_0.4.2      munsell_0.5.1         </span></span>
<span><span class="co">## [133] lazyeval_0.2.2         spatstat.geom_3.3-6    glmnet_4.1-8          </span></span>
<span><span class="co">## [136] Matrix_1.7-2           RcppHNSW_0.6.0         hms_1.1.3             </span></span>
<span><span class="co">## [139] patchwork_1.3.0        future_1.34.0          shiny_1.10.0          </span></span>
<span><span class="co">## [142] ROCR_1.0-11            igraph_2.1.4           bslib_0.9.0</span></span></code></pre>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Bin Duan, Hua Zou.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
